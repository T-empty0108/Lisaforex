<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>XAU/USD ‚Äî OANDA + VIDYA</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:#000;color:#e2e8f0;height:100vh;overflow:hidden}
        .app{display:flex;flex-direction:column;height:100vh;padding:10px 14px;gap:8px}
        .top-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:linear-gradient(135deg,#080810,#0a0a14);border:1px solid #1a1a2e;border-radius:14px;flex-shrink:0}
        .top-left{display:flex;align-items:center;gap:16px}
        .pair-name{font-size:22px;font-weight:800;background:linear-gradient(135deg,#fbbf24,#f59e0b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:1px}
        .source-tag{font-size:10px;font-weight:700;color:#fbbf24;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);padding:2px 8px;border-radius:6px}
        .indicator-tag{font-size:10px;font-weight:700;color:#a78bfa;background:rgba(167,139,250,.1);border:1px solid rgba(167,139,250,.3);padding:2px 8px;border-radius:6px}
        .live-price{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;color:#fff;transition:color .3s}
        .live-price.up{color:#089981}.live-price.down{color:#f23645}
        .price-change{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;padding:4px 10px;border-radius:8px}
        .price-change.up{background:rgba(8,153,129,.15);color:#089981}.price-change.down{background:rgba(242,54,69,.15);color:#f23645}
        .top-right{display:flex;align-items:center;gap:14px}
        .status-dot-live{width:10px;height:10px;border-radius:50%;background:#089981;animation:pd 2s infinite}
        .status-dot-live.error{background:#f23645}.status-dot-live.loading{background:#fbbf24}
        @keyframes pd{0%,100%{opacity:1}50%{opacity:.3}}
        .status-info{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
        .status-text{font-size:12px;color:#64748b;font-weight:600}
        .status-text span{font-family:'JetBrains Mono',monospace;color:#94a3b8}
        .tf-buttons{display:flex;gap:4px}
        .tf-btn{padding:5px 10px;border-radius:8px;font-size:12px;font-weight:700;border:1px solid #1a1a2e;background:transparent;color:#64748b;cursor:pointer;transition:all .2s;font-family:'JetBrains Mono',monospace}
        .tf-btn:hover{border-color:#fbbf24;color:#fbbf24}
        .tf-btn.active{background:rgba(251,191,36,.15);border-color:#fbbf24;color:#fbbf24}
        .chart-wrapper{flex:1;border-radius:14px;overflow:hidden;border:1px solid #1a1a2e;background:#000;position:relative;min-height:0}
        #chart{width:100%;height:100%}
        .watermark{position:absolute;bottom:50px;left:50%;transform:translateX(-50%);font-size:52px;font-weight:800;color:rgba(255,255,255,.02);letter-spacing:8px;z-index:5;pointer-events:none}
        .stats-bar{display:flex;gap:8px;padding:8px 16px;background:linear-gradient(135deg,#080810,#0a0a14);border:1px solid #1a1a2e;border-radius:14px;flex-shrink:0}
        .stat-item{flex:1;padding:8px 12px;text-align:center;background:rgba(0,0,0,.5);border-radius:10px;border:1px solid #1a1a2e}
        .stat-label{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px}
        .stat-value{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;color:#fff}
        .stat-value.up{color:#089981}.stat-value.down{color:#f23645}
        .overlay-msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:15px;color:#94a3b8;font-weight:600;background:rgba(0,0,0,.92);padding:20px 30px;border-radius:12px;border:1px solid #1a1a2e;z-index:20;text-align:center;line-height:1.6}
        .overlay-msg.hidden{display:none}
        .overlay-msg .spinner{display:inline-block;width:18px;height:18px;border:2px solid #1a1a2e;border-top:2px solid #fbbf24;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:8px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .scroll-mode-btns{position:absolute;bottom:12px;right:12px;z-index:16;display:flex;gap:4px}
        .scroll-mode-btn{width:32px;height:32px;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:800;border:1px solid #1a1a2e;background:rgba(0,0,0,.7);color:#555;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .scroll-mode-btn:hover{border-color:#fbbf24;color:#fbbf24}
        .scroll-mode-btn.active{background:rgba(251,191,36,.15);border-color:#fbbf24;color:#fbbf24}
    </style>
</head>
<body>
<div class="app">
    <div class="top-bar">
        <div class="top-left">
            <div class="pair-name">‚öú XAU / USD</div>
            <div class="source-tag">OANDA</div>
            <div class="indicator-tag">VIDYA</div>
            <div class="live-price" id="livePrice">Connecting...</div>
            <div class="price-change up" id="priceChange">--</div>
        </div>
        <div class="top-right">
            <div class="tf-buttons">
                <button class="tf-btn active" data-tf="1">1m</button>
                <button class="tf-btn" data-tf="5">5m</button>
                <button class="tf-btn" data-tf="15">15m</button>
                <button class="tf-btn" data-tf="60">1h</button>
            </div>
            <div class="status-dot-live loading" id="statusDot"></div>
            <div class="status-info">
                <div class="status-text">Ticks: <span id="tickCount">0</span></div>
                <div class="status-text">Updated: <span id="updateTime">--:--:--</span></div>
            </div>
        </div>
    </div>
    <div class="chart-wrapper">
        <div id="chart"></div>
        <div class="watermark">XAU/USD</div>
        <div class="overlay-msg" id="overlay"><span class="spinner"></span> ƒêang k·∫øt n·ªëi...</div>
        <!-- VIDYA legend and Vol Delta removed -->
        <div class="scroll-mode-btns">
            <button class="scroll-mode-btn active" id="btnA" title="Auto scroll">A</button>
            <button class="scroll-mode-btn" id="btnP" title="Elastic pin">P</button>
        </div>
    </div>
    <div class="stats-bar">
        <div class="stat-item"><div class="stat-label">24h Open</div><div class="stat-value" id="statOpen">---</div></div>
        <div class="stat-item"><div class="stat-label">24h High</div><div class="stat-value up" id="statHigh">---</div></div>
        <div class="stat-item"><div class="stat-label">24h Low</div><div class="stat-value down" id="statLow">---</div></div>
        <div class="stat-item"><div class="stat-label">24h Range</div><div class="stat-value" id="statSpread">---</div></div>
        <div class="stat-item"><div class="stat-label">Latency</div><div class="stat-value" id="statLatency">---</div></div>
        <div class="stat-item"><div class="stat-label">Candles</div><div class="stat-value" id="statCandles">---</div></div>
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<script>
(()=>{
    const SERVER = window.location.origin;
    const WS_URL = SERVER.replace("http","ws");
    const HIST_BARS = {"1":1500,"5":500,"15":300,"60":200};
    const INT_SEC = {"1":60,"5":300,"15":900,"60":3600};
    const BG = '#000000';

    // Colors
    const C_UP = '#089981', C_DN = '#f23645';
    const C_VUP = '#17d6a6', C_VDN = '#d33066';

    // State
    let curTF = "1", curSec = 60;
    let hist = [], liveC = null, ticks = 0;
    let sHi = 0, sLo = Infinity, sOpen = null, prevP = null;
    let lastHT = 0, ready = false, ws = null;
    let extra = [], cSeries = null, saved = null;
    let scrollM = 'auto';

    // Store VIDYA line series per segment for markers
    let vidyaLineSeries = [];

    const chartEl = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartEl, {
        layout: { background: { type:'solid', color:BG }, textColor:'#9a9ab0', fontFamily:"'JetBrains Mono',monospace", fontSize:12 },
        grid: { vertLines:{ color:'rgba(255,255,255,0.04)' }, horzLines:{ color:'rgba(255,255,255,0.04)' } },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: { color:'rgba(251,191,36,0.3)', width:1, style:2, labelBackgroundColor:'#1a1a2e' },
            horzLine: { color:'rgba(251,191,36,0.3)', width:1, style:2, labelBackgroundColor:'#1a1a2e' },
        },
        rightPriceScale: { borderColor:'#1a1a2e', scaleMargins:{ top:0.05, bottom:0.05 } },
        timeScale: { borderColor:'#1a1a2e', timeVisible:true, secondsVisible:false, barSpacing:6, rightOffset:5 },
        localization: { timeFormatter: t => new Date(t*1000).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}) },
    });

    // cSeries created dynamically in loadHist ‚Äî added AFTER indicator layers so candles render on top

    function clrExtra() {
        for (const s of extra) { try { chart.removeSeries(s); } catch(e) {} }
        extra = [];
        vidyaLineSeries = [];
        // Remove old candle series so it can be re-added on top after indicators
        if (cSeries) { try { chart.removeSeries(cSeries); } catch(e) {} cSeries = null; }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SCROLL: Auto / Elastic Pin
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function setScroll(m) {
        scrollM = m;
        document.getElementById('btnA').classList.toggle('active', m === 'auto');
        document.getElementById('btnP').classList.toggle('active', m === 'pin');
        if (m === 'auto') chart.timeScale().scrollToRealTime();
    }
    document.getElementById('btnA').addEventListener('click', () => setScroll('auto'));
    document.getElementById('btnP').addEventListener('click', () => setScroll('pin'));

    function smartScroll() {
        if (scrollM === 'auto') { chart.timeScale().scrollToRealTime(); return; }
        const lc = liveC || (hist.length ? hist[hist.length-1] : null);
        if (!lc || !cSeries) return;
        const vr = chart.timeScale().getVisibleLogicalRange();
        if (!vr) return;
        const vw = vr.to - vr.from;
        const allLen = hist.length + (liveC && liveC.time > lastHT ? 1 : 0);
        const ovX = allLen - 1 - vr.to;
        if (ovX > vw * 0.25) {
            chart.timeScale().setVisibleLogicalRange({ from: vr.from + ovX - 2, to: vr.to + ovX - 2 });
            return;
        }
        try {
            const h = chartEl.clientHeight;
            const py = cSeries.priceToCoordinate(lc.close);
            if (py !== null && !isNaN(py)) {
                const buf = h * 0.25;
                if (py < -buf || py > h + buf) chart.timeScale().scrollToRealTime();
            }
        } catch(e) {}
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SESSION SEPARATORS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderSessions() {
        if (!hist.length) return;
        const iSec = INT_SEC[curTF];
        if (iSec > 900) return;
        const first = hist[0].time, last = hist[hist.length-1].time;
        const ds = Math.floor(first / 86400) * 86400;
        const de = Math.floor(last / 86400) * 86400 + 86400;
        const defs = [
            { name:'ASIA', h:0, lc:'rgba(255,200,50,0.15)', tc:'rgba(255,200,50,0.5)' },
            { name:'LONDON', h:8, lc:'rgba(50,150,255,0.15)', tc:'rgba(50,150,255,0.5)' },
            { name:'NEW YORK', h:13, lc:'rgba(255,80,120,0.15)', tc:'rgba(255,80,120,0.5)' },
        ];
        for (let day = ds; day <= de; day += 86400) {
            for (const d of defs) {
                const t = day + d.h * 3600;
                if (t < first - iSec * 5 || t > last + iSec * 5) continue;
                const sn = Math.round(t / iSec) * iSec;
                const ls = chart.addLineSeries({
                    color: d.lc, lineWidth:1, lineStyle:2,
                    lastValueVisible:false, priceLineVisible:false, crosshairMarkerVisible:false,
                });
                ls.setData([{ time:sn, value:0 }]);
                ls.setMarkers([{ time:sn, position:'aboveBar', color:d.tc, shape:'square', text:d.name, size:0 }]);
                extra.push(ls);
            }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOAD HISTORY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadHist(tf) {
        const ov = document.getElementById('overlay');
        ov.innerHTML = `<span class="spinner"></span> ƒêang t·∫£i OANDA (${tf}m) + VIDYA...`;
        ov.classList.remove('hidden');
        try {
            const resp = await fetch(`${SERVER}/api/history?interval=${tf}&bars=${HIST_BARS[tf]||500}`);
            const data = await resp.json();
            if (data.error) { ov.innerHTML = `‚ö†Ô∏è ${data.error}`; setTimeout(() => ov.classList.add('hidden'), 3000); return; }
            hist = data.candles || [];
            lastHT = hist.length ? hist[hist.length-1].time : 0;
            calcS();
            clrExtra();

            renderSessions();
            if (data.indicator) { saved = data.indicator; renderVIDYA(data.indicator); }

            // Create candle series LAST ‚Äî renders on top of all indicator layers
            cSeries = chart.addCandlestickSeries({
                upColor:C_UP, downColor:C_DN, borderUpColor:C_UP, borderDownColor:C_DN,
                wickUpColor:C_UP, wickDownColor:C_DN,
                lastValueVisible: true,   // single price label on axis
                priceLineVisible: false,   // no full-width horizontal line
            });
            renderAll();

            ov.classList.add('hidden');
            console.log(`‚úÖ ${hist.length} candles | VIDYA: ${data.indicator?.vidya_line?.length||0}`);
        } catch(e) {
            console.error("Load:", e);
            ov.innerHTML = '‚ö†Ô∏è Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server';
            setTimeout(() => ov.classList.add('hidden'), 3000);
        }
    }

    function calcS() {
        sOpen = null; sHi = 0; sLo = Infinity;
        for (const c of hist) {
            if (!sOpen) sOpen = c.open;
            if (c.high > sHi) sHi = c.high;
            if (c.low < sLo) sLo = c.low;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VIDYA FILL ‚Äî Neon glow at VIDYA line, fading to transparent at candles
    //
    // Lightweight Charts area: topColor at line ‚Üí bottomColor at chart bottom
    //
    // UPTREND (vidya below candles):
    //   1. Gradient area from HL2 line:
    //      topColor = transparent (at hl2/candle level)
    //      bottomColor = bright neon (going down toward vidya)
    //      ‚Üí Creates: transparent near candles ‚Üí bright near vidya ‚úì
    //   2. Clip mask from VIDYA line:
    //      Solid background color ‚Üí hides everything below vidya
    //      (invisible because it matches the #000 background)
    //
    // DOWNTREND (vidya above candles):
    //   1. Gradient area from VIDYA line:
    //      topColor = bright neon (at vidya level)
    //      bottomColor = transparent (going down toward hl2)
    //      ‚Üí Creates: bright at vidya ‚Üí transparent near candles ‚úì
    //   2. Clip mask from HL2 line:
    //      Solid background color ‚Üí hides everything below hl2
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderVIDYA(ind) {
        if (!ind?.vidya_line?.length) return;

        const hl2M = {};
        for (const c of hist) hl2M[c.time] = r3((c.high + c.low) / 2);

        // Build segments by trend
        const segs = [];
        let s = { tr: ind.vidya_line[0].trend, pts: [ind.vidya_line[0]] };
        for (let i = 1; i < ind.vidya_line.length; i++) {
            const p = ind.vidya_line[i];
            if (p.trend !== s.tr) { segs.push(s); s = { tr: p.trend, pts: [p] }; }
            else s.pts.push(p);
        }
        segs.push(s);

        vidyaLineSeries = [];

        for (let si = 0; si < segs.length; si++) {
            const seg = segs[si];
            if (seg.pts.length < 2) continue;
            const up = seg.tr === "up";
            const isLast = (si === segs.length - 1);

            // Prepare data arrays
            const vD = [], hD = [];
            for (const p of seg.pts) {
                const h = hl2M[p.time];
                if (h === undefined) continue;
                vD.push({ time: p.time, value: p.value });
                hD.push({ time: p.time, value: h });
            }
            if (vD.length < 2) continue;

            // ‚îÄ‚îÄ Neon glow fill: bright at VIDYA, transparent at candles ‚îÄ‚îÄ

            if (up) {
                // UPTREND: vidya is below, hl2 is above
                // Gradient from HL2: transparent at top ‚Üí bright neon going down
                const gradientFill = chart.addAreaSeries({
                    topColor: 'rgba(23,214,166,0.0)',       // transparent at hl2 (candle level)
                    bottomColor: 'rgba(23,214,166,0.45)',    // bright neon going down toward vidya
                    lineColor: 'transparent', lineWidth: 0,
                    lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false,
                });
                gradientFill.setData(hD);
                extra.push(gradientFill);

                // Clip mask from VIDYA: solid BG to hide fill below vidya line
                // This is invisible because it matches the chart background (#000)
                const clipMask = chart.addAreaSeries({
                    topColor: BG, bottomColor: BG,
                    lineColor: 'transparent', lineWidth: 0,
                    lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false,
                });
                clipMask.setData(vD);
                extra.push(clipMask);

            } else {
                // DOWNTREND: vidya is above, hl2 is below
                // Gradient from VIDYA: bright neon at top ‚Üí transparent going down
                const gradientFill = chart.addAreaSeries({
                    topColor: 'rgba(211,48,102,0.45)',       // bright neon at vidya line
                    bottomColor: 'rgba(211,48,102,0.0)',     // transparent going down toward candles
                    lineColor: 'transparent', lineWidth: 0,
                    lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false,
                });
                gradientFill.setData(vD);
                extra.push(gradientFill);

                // Clip mask from HL2: solid BG to hide fill below hl2 line
                const clipMask = chart.addAreaSeries({
                    topColor: BG, bottomColor: BG,
                    lineColor: 'transparent', lineWidth: 0,
                    lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false,
                });
                clipMask.setData(hD);
                extra.push(clipMask);
            }

            // ‚îÄ‚îÄ VIDYA line (drawn on top of fill) ‚îÄ‚îÄ
            const ln = chart.addLineSeries({
                color: up ? C_VUP : C_VDN, lineWidth: 2,
                lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false,
            });
            ln.setData(vD);
            extra.push(ln);

            // ‚îÄ‚îÄ Markers on the VIDYA line series ‚îÄ‚îÄ
            const markers = [];

            // ‚ñ≤/‚ñº at start of segment
            markers.push({
                time: vD[0].time,
                position: up ? 'belowBar' : 'aboveBar',
                color: up ? C_VUP : C_VDN,
                shape: up ? 'arrowUp' : 'arrowDown',
                text: '', size: 1,
            });

            // ‚ú™ at end ‚Äî only for the last (active) segment
            if (isLast && vD.length > 1) {
                markers.push({
                    time: vD[vD.length - 1].time,
                    position: up ? 'belowBar' : 'aboveBar',
                    color: up ? C_VUP : C_VDN,
                    shape: 'circle', text: '', size: 0,
                });
            }

            markers.sort((a, b) => a.time - b.time);
            ln.setMarkers(markers);

            vidyaLineSeries.push({
                series: ln, trend: seg.tr,
                startTime: vD[0].time, endTime: vD[vD.length-1].time,
                isLast: isLast,
            });
        }

        // ‚îÄ‚îÄ Liquidity lines ‚îÄ‚îÄ
        if (ind.liquidity) {
            const iS = INT_SEC[curTF];
            for (const liq of ind.liquidity) {
                const ld = [];
                for (let j = 0; j <= 5; j++) ld.push({ time: liq.time + j * iS, value: liq.price });
                const ls = chart.addLineSeries({
                    color: liq.type === "support" ? 'rgba(23,214,166,0.4)' : 'rgba(211,48,102,0.4)',
                    lineWidth: 1, lineStyle: 0,
                    lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false,
                });
                ls.setData(ld);
                extra.push(ls);
            }
        }

        // ‚îÄ‚îÄ Float Vol Delta removed ‚îÄ‚îÄ
    }

    function r3(v) { return Math.round(v * 1000) / 1000; }

    // (Price line removed ‚Äî using single lastValueVisible label on candle series)

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WEBSOCKET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function connectWS() {
        if (ws) { ws.close(); ws = null; }
        ws = new WebSocket(`${WS_URL}/ws/price`);
        ws.onopen = () => {
            console.log("üîå WS connected");
            document.getElementById('statusDot').className = 'status-dot-live';
        };
        ws.onmessage = e => {
            try { const m = JSON.parse(e.data); if (m.type === "tick") onTick(m.price, m.latency); } catch(e) {}
        };
        ws.onclose = () => {
            document.getElementById('statusDot').className = 'status-dot-live error';
            setTimeout(connectWS, 3000);
        };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TICK
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function onTick(price, lat) {
        const now = Math.floor(Date.now() / 1000);
        ticks++;
        if (!sOpen) sOpen = price;
        if (price > sHi) sHi = price;
        if (price < sLo) sLo = price;

        const ct = Math.floor(now / curSec) * curSec;
        if (liveC && liveC.time !== ct) pushH();
        if (!liveC || liveC.time !== ct) {
            liveC = { time: ct, open: price, high: price, low: price, close: price };
        } else {
            liveC.close = price;
            if (price > liveC.high) liveC.high = price;
            if (price < liveC.low) liveC.low = price;
        }

        rTick(price, ct);
        updUI(price, lat);
        prevP = price;
    }

    function pushH() {
        if (!liveC) return;
        const i = hist.findIndex(c => c.time === liveC.time);
        if (i >= 0) hist[i] = { ...liveC };
        else if (liveC.time > lastHT) { hist.push({ ...liveC }); lastHT = liveC.time; }
        liveC = null;
    }

    function rTick(price, ct) {
        if (!cSeries) return;
        if (hist.length) {
            const last = hist[hist.length - 1];
            if (last.time === ct) {
                last.close = price;
                if (price > last.high) last.high = price;
                if (price < last.low) last.low = price;
                if (ready) cSeries.update(last);
                else { cSeries.setData(hist); ready = true; }
                smartScroll(); updCC(); return;
            }
        }
        if (liveC) {
            if (!ready) {
                const a = [...hist];
                if (liveC.time > lastHT) a.push(liveC);
                cSeries.setData(a); ready = true;
            } else {
                cSeries.update(liveC);
            }
            updCC();
        }
        smartScroll();
    }

    function renderAll() {
        if (!cSeries) return;
        let a = [...hist];
        if (liveC && liveC.time > lastHT) a.push(liveC);
        cSeries.setData(a);
        smartScroll();
        ready = true;
        updCC();
    }

    function updCC() {
        let c = hist.length;
        if (liveC && liveC.time > lastHT) c++;
        document.getElementById('statCandles').textContent = c;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AUTO REFRESH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let rTimer = null;
    function startRefresh() {
        if (rTimer) clearInterval(rTimer);
        rTimer = setInterval(async () => {
            try {
                const r = await fetch(`${SERVER}/api/history?interval=${curTF}&bars=10`);
                const d = await r.json();
                if (!d.candles) return;
                let u = 0;
                for (const nc of d.candles) {
                    const i = hist.findIndex(c => c.time === nc.time);
                    if (i >= 0) { hist[i] = nc; u++; }
                    else if (nc.time > lastHT) { hist.push(nc); lastHT = nc.time; u++; }
                }
                if (u > 0) { hist.sort((a,b) => a.time - b.time); renderAll(); }
            } catch(e) {}
        }, 60000);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UI UPDATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updUI(price, lat) {
        const el = document.getElementById('livePrice');
        el.textContent = price.toFixed(2);
        if (prevP !== null) {
            el.classList.remove('up', 'down');
            if (price > prevP) el.classList.add('up');
            else if (price < prevP) el.classList.add('down');
            setTimeout(() => el.classList.remove('up', 'down'), 600);
        }
        if (sOpen !== null) {
            const chg = price - sOpen;
            const ce = document.getElementById('priceChange');
            ce.textContent = (chg >= 0 ? '+' : '') + chg.toFixed(2);
            ce.className = 'price-change ' + (chg >= 0 ? 'up' : 'down');
        }
        const d = new Date();
        document.getElementById('updateTime').textContent =
            [d.getHours(), d.getMinutes(), d.getSeconds()].map(v => String(v).padStart(2,'0')).join(':');
        document.getElementById('tickCount').textContent = ticks;
        document.getElementById('statOpen').textContent = sOpen ? sOpen.toFixed(2) : '---';
        document.getElementById('statHigh').textContent = sHi > 0 ? sHi.toFixed(2) : '---';
        document.getElementById('statLow').textContent = sLo < Infinity ? sLo.toFixed(2) : '---';
        document.getElementById('statSpread').textContent = (sHi > 0 && sLo < Infinity) ? (sHi - sLo).toFixed(2) : '---';
        if (lat > 0) document.getElementById('statLatency').textContent = lat + 'ms';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TF BUTTONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.querySelectorAll('.tf-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            curTF = btn.dataset.tf;
            curSec = INT_SEC[curTF];
            liveC = null; ready = false; saved = null;
            clrExtra();
            setScroll('auto');
            await loadHist(curTF);
            startRefresh();
        });
    });

    new ResizeObserver(entries => {
        for (const e of entries) chart.applyOptions({ width: e.contentRect.width, height: e.contentRect.height });
    }).observe(chartEl);

    chart.timeScale().subscribeVisibleTimeRangeChange(() => {});

    (async () => {
        console.log("üöÄ XAU/USD v14 ‚Äî candles on top, single price label, no price line");
        curSec = INT_SEC[curTF];
        await loadHist(curTF);
        connectWS();
        startRefresh();
    })();
})();
</script>
</body>
</html>